<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易马里奥风格游戏</title>
    <style>
        /* 游戏页面的基本样式 */
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #222; /* 深色背景衬托游戏 */
            font-family: 'Arial', sans-serif;
            flex-direction: column;
            color: white;
        }
        
        /* 游戏画布样式 */
        canvas {
            border: 4px solid #555;
            background-color: #87CEEB; /* 天空蓝背景 */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            image-rendering: pixelated; /* 让像素风格更清晰（如果有图片的话）*/
        }
        .instructions {
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="800" height="450"></canvas>
    
    <div class="instructions">
        <p>⬅️➡️ 或 A/D 移动 | ⬆️, W 或 空格键 跳跃</p>
        <p>目标：跳过平台，避开棕色方块敌人</p>
    </div>

    <script>
        // --- 1. 游戏设置与变量定义 ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 游戏全局变量
        const gravity = 0.8;  // 重力加速度
        let gameRunning = true;

        // 玩家对象（马里奥）
        const player = {
            x: 50,
            y: 200,
            width: 30,
            height: 40,
            color: 'red', // 暂时用红色方块代替马里奥
            vx: 0, // 水平速度
            vy: 0, // 垂直速度
            speed: 6, // 移动速度
            jumpStrength: -14, // 跳跃力度
            grounded: false // 是否在地面上
        };

        // 平台数组（地面和浮空砖块）
        const platforms = [
            { x: 0, y: 400, width: 800, height: 50, color: '#66BB6A' }, // 主地面 (绿色)
            { x: 200, y: 300, width: 100, height: 20, color: '#8D6E63' }, // 砖块平台 1
            { x: 450, y: 220, width: 100, height: 20, color: '#8D6E63' }, // 砖块平台 2
            { x: 100, y: 150, width: 80, height: 20, color: '#8D6E63' },  // 砖块平台 3
            { x: 650, y: 320, width: 80, height: 20, color: '#8D6E63' }   // 砖块平台 4
        ];

        // 简单的敌人类（栗宝宝原型）
        class Enemy {
            constructor(x, y, patrolDistance) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 30;
                this.color = 'brown';
                this.vx = 2; // 移动速度
                this.startX = x;
                this.patrolDistance = patrolDistance;
            }
            update() {
                this.x += this.vx;
                // 简单的巡逻逻辑
                if (this.x > this.startX + this.patrolDistance || this.x < this.startX) {
                    this.vx *= -1; // 转向
                }
            }
            draw() {
                drawRect(this.x, this.y, this.width, this.height, this.color);
            }
        }

        // 创建敌人实例
        const enemies = [
            new Enemy(300, 370, 150), // 在地面巡逻
            new Enemy(470, 190, 60)   // 在平台上巡逻
        ];


        // --- 2. 输入控制 ---
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            // 防止空格键滚动页面
            if(['Space', 'ArrowUp', 'ArrowDown'].includes(e.code)) e.preventDefault();
        });
        document.addEventListener('keyup', (e) => keys[e.code] = false);


        // --- 3. 核心游戏逻辑 ---

        // 辅助绘图函数
        function drawRect(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y, w, h);
        }

        // 矩形碰撞检测 (AABB)
        function checkCollision(rect1, rect2) {
            return (
                rect1.x < rect2.x + rect2.width &&
                rect1.x + rect1.width > rect2.x &&
                rect1.y < rect2.y + rect2.height &&
                rect1.y + rect1.height > rect2.y
            );
        }

        function resetGame() {
            player.x = 50;
            player.y = 200;
            player.vx = 0;
            player.vy = 0;
        }

        function update() {
            if (!gameRunning) return;

            // -> 水平移动
            if (keys['ArrowRight'] || keys['KeyD']) {
                player.vx = player.speed;
            } else if (keys['ArrowLeft'] || keys['KeyA']) {
                player.vx = -player.speed;
            } else {
                player.vx = 0;
            }
            player.x += player.vx;

            // -> 边界限制 (防止跑出屏幕)
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

            // -> 垂直移动与重力
            player.vy += gravity;
            player.y += player.vy;
            player.grounded = false; // 假设我们在空中，直到检测到碰撞

            // -> 平台碰撞检测 (核心物理)
            platforms.forEach(plat => {
                // 这是一个简化的碰撞，主要处理从上方落在平台上
                // 我们检查玩家的脚是否在平台顶部附近，并且玩家正在向下移动
                if (player.y + player.height > plat.y && 
                    player.y + player.height < plat.y + plat.height &&
                    player.x + player.width > plat.x && 
                    player.x < plat.x + plat.width &&
                    player.vy > 0 // 只有在下落时才碰撞
                    ) {
                    player.grounded = true;
                    player.vy = 0;
                    player.y = plat.y - player.height; // 将玩家置于平台上方
                }
            });

            // -> 跳跃
            // 只有在地面上才能跳跃
            if ((keys['ArrowUp'] || keys['Space'] || keys['KeyW']) && player.grounded) {
                player.vy = player.jumpStrength;
                player.grounded = false;
            }

            // -> 敌人更新与碰撞
            enemies.forEach(enemy => {
                enemy.update();
                if (checkCollision(player, enemy)) {
                    // 简单的机制：碰到敌人就重置
                    // 真正的马里奥里需要判断是从上方踩踏还是侧面碰撞
                    resetGame(); 
                    // 可以添加一个闪烁效果或“Game Over”提示
                }
            });
            
            // -> 掉出屏幕底部判定
            if(player.y > canvas.height) {
                resetGame();
            }
        }

        // --- 4. 渲染循环 ---
        function draw() {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制平台
            platforms.forEach(plat => {
                drawRect(plat.x, plat.y, plat.width, plat.height, plat.color);
                // 给平台加个深色边框增加立体感
                ctx.strokeStyle = '#5D4037';
                ctx.lineWidth = 2;
                ctx.strokeRect(plat.x, plat.y, plat.width, plat.height);
            });

            // 绘制敌人
            enemies.forEach(enemy => enemy.draw());

            // 绘制玩家 (红色方块)
            drawRect(player.x, player.y, player.width, player.height, player.color);
            // 给玩家加个眼睛，稍微生动一点
            ctx.fillStyle = 'white';
            ctx.fillRect(player.x + 20, player.y + 10, 5, 5);


            // 绘制简单的UI
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.fillText("Score: 0 (WIP)", 10, 30);
        }

        // --- 5. 游戏主循环 ---
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // 启动游戏
        gameLoop();

    </script>
</body>
</html>
